/*
 * JS for startScreen generated by Appery.io
 */

Apperyio.getProjectGUID = function() {
    return '1f38939d-7f15-41c3-b797-827ef950ad9c';
};

function navigateTo(outcome, useAjax) {
    Apperyio.navigateTo(outcome, useAjax);
}

function adjustContentHeight() {
    Apperyio.adjustContentHeightWithPadding();
}

function adjustContentHeightWithPadding(_page) {
    Apperyio.adjustContentHeightWithPadding(_page);
}

function setDetailContent(pageUrl) {
    Apperyio.setDetailContent(pageUrl);
}

Apperyio.AppPages = [{
    "name": "startScreen",
    "location": "startScreen.html"
}];

function startScreen_js() {

    /* Object & array with components "name-to-id" mapping */
    var n2id_buf = {
        'header_button': 'startScreen_header_button',
        'filters': 'startScreen_filters',
        'details': 'startScreen_details',
        'google_map': 'startScreen_google_map',
        'marker_3': 'startScreen_marker_3',
        'recenter': 'startScreen_recenter',
        'drop_pin': 'startScreen_drop_pin',
        'Output': 'startScreen_Output',
        'mobilegrid_361': 'startScreen_mobilegrid_361',
        'mobilegridcell_362': 'startScreen_mobilegridcell_362',
        'mobileimage_330': 'startScreen_mobileimage_330',
        'mobilelabel_366': 'startScreen_mobilelabel_366',
        'mobilegridcell_363': 'startScreen_mobilegridcell_363',
        'mobileimage_333': 'startScreen_mobileimage_333',
        'mobilelabel_367': 'startScreen_mobilelabel_367',
        'mobilegrid_17': 'startScreen_mobilegrid_17',
        'mobilegridcell_18': 'startScreen_mobilegridcell_18',
        'mobilegridcell_19': 'startScreen_mobilegridcell_19',
        'spin_button': 'startScreen_spin_button',
        'mobilegridcell_24': 'startScreen_mobilegridcell_24',
        'filters_header': 'startScreen_filters_header',
        'spacer_364': 'startScreen_spacer_364',
        'mobilegrid_278': 'startScreen_mobilegrid_278',
        'mobilegridcell_279': 'startScreen_mobilegridcell_279',
        'one_dollar': 'startScreen_one_dollar',
        'mobilegridcell_280': 'startScreen_mobilegridcell_280',
        'two_dollars': 'startScreen_two_dollars',
        'mobilegridcell_283': 'startScreen_mobilegridcell_283',
        'three_dollars': 'startScreen_three_dollars',
        'mobilegridcell_284': 'startScreen_mobilegridcell_284',
        'four_dollars': 'startScreen_four_dollars',
        'distance_menu': 'startScreen_distance_menu',
        'distance_menu-0': 'startScreen_distance_menu-0',
        'rating_menu': 'startScreen_rating_menu',
        'rating_menu-0': 'startScreen_rating_menu-0',
        'mobilecollapsblock_300': 'startScreen_mobilecollapsblock_300',
        'cuisine_collapse': 'startScreen_cuisine_collapse',
        'mobilecollapsblockcontent_302': 'startScreen_mobilecollapsblockcontent_302',
        'mobilecheckboxgroup_303': 'startScreen_mobilecheckboxgroup_303',
        'mobilecheckbox_304': 'startScreen_mobilecheckbox_304',
        'mobilecheckbox_305': 'startScreen_mobilecheckbox_305',
        'mobilecheckbox_306': 'startScreen_mobilecheckbox_306',
        'mobilecheckbox_307': 'startScreen_mobilecheckbox_307',
        'mobilecheckbox_308': 'startScreen_mobilecheckbox_308',
        'mobilecheckbox_309': 'startScreen_mobilecheckbox_309',
        'mobilecheckbox_310': 'startScreen_mobilecheckbox_310',
        'mobilegrid_369': 'startScreen_mobilegrid_369',
        'mobilegridcell_370': 'startScreen_mobilegridcell_370',
        'mobilegridcell_371': 'startScreen_mobilegridcell_371',
        'close_filters': 'startScreen_close_filters',
        'mobilegridcell_374': 'startScreen_mobilegridcell_374',
        'mobilegrid_389': 'startScreen_mobilegrid_389',
        'mobilegridcell_390': 'startScreen_mobilegridcell_390',
        'reserve_table': 'startScreen_reserve_table',
        'mobilegridcell_391': 'startScreen_mobilegridcell_391',
        'opentable_logo': 'startScreen_opentable_logo',
        'mobilegrid_377': 'startScreen_mobilegrid_377',
        'mobilegridcell_378': 'startScreen_mobilegridcell_378',
        'mobilegridcell_379': 'startScreen_mobilegridcell_379',
        'close_details': 'startScreen_close_details',
        'mobilegridcell_382': 'startScreen_mobilegridcell_382'
    };

    if ("n2id" in window && window.n2id !== undefined) {
        $.extend(n2id, n2id_buf);
    } else {
        window.n2id = n2id_buf;
    }

    /*
     * Nonvisual components
     */

    Apperyio.mappings = Apperyio.mappings || {};

    Apperyio.mappings["startScreen_Output_onchange_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "name",
            "from_type": "LOCAL_STORAGE",

            "to_name": "startScreen",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$",
                "target": "$['Output:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_geolocation1_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {

            "to_name": "geolocation1",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "data": {
                    "options": {
                        "maximumAge": 3000,
                        "timeout": 5000,
                        "enableHighAccuracy": true,
                        "watchPosition": false
                    }
                }
            },

            "mappings": []
        }

        ]
    };

    Apperyio.mappings["startScreen_geolocation1_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "geolocation1",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "startScreen",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$['data']['coords']['latitude']",
                "target": "$['google_map:latitude']"

            },

            {

                "source": "$['data']['coords']['longitude']",
                "target": "$['google_map:longitude']"

            }

            ]
        },

        {
            "from_name": "geolocation1",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "markerLat",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['data']['coords']['latitude']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "geolocation1",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "markerLng",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['data']['coords']['longitude']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_get_details_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "website",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['website']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "name",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['name']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "restaurantLat",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['geometry']['location']['lat']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "restaurantLng",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['geometry']['location']['lng']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "status",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['status']",
                "target_transformation": function(value) {
                    if (value == "INVALID_REQUEST") {
                        localStorage.setItem('restaurantLat', localStorage.getItem('markerLat'));
                        localStorage.setItem('restaurantLng', localStorage.getItem('markerLng'));
                        localStorage.setItem('name', 'No restaurants found');
                        localStorage.setItem('website', 'Change filters and spin again');
                        localStorage.setItem('phone_number', ' ');
                        localStorage.setItem('open', ' ');
                        console.log('Response is empty');
                        localStorage.setItem('results', []);
                    }
                },
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "phone_number",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['formatted_phone_number']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "get_details",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "open",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['result']['opening_hours']['open_now']",
                "target_transformation": function(value) {
                    if (value == 1) {
                        return ("Open");
                    } else {
                        return ("Not open");
                    }
                },
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_get_details_oncomplete_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "name",
            "from_type": "LOCAL_STORAGE",

            "to_name": "startScreen",
            "to_type": "UI",

            "mappings": [

            {

                "source": "$",
                "target": "$['Output:text']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_get_details_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "place_id",
            "from_type": "LOCAL_STORAGE",

            "to_name": "get_details",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {},
                "parameters": {
                    "key": "AIzaSyB_QWi7zPKtb69Nl11UJoFUsaxqZZztYWk"
                },
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['placeid']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_radar_search_onbeforesend_mapping_1"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "markerLatLng",
            "from_type": "LOCAL_STORAGE",

            "to_name": "radar_search",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {},
                "parameters": {
                    "key": "AIzaSyB_QWi7zPKtb69Nl11UJoFUsaxqZZztYWk",
                    "types": "restaurant|food|meal_delivery|meal_takeaway|bar|cafe",
                    "opennow": "true"
                },
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['location']"

            }

            ]
        },

        {
            "from_name": "startScreen",
            "from_type": "UI",

            "to_name": "radar_search",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {},
                "parameters": {
                    "key": "AIzaSyB_QWi7zPKtb69Nl11UJoFUsaxqZZztYWk",
                    "types": "restaurant|food|meal_delivery|meal_takeaway|bar|cafe",
                    "opennow": "true"
                },
                "body": null
            },

            "mappings": [

            {

                "source": "$['distance_menu:selectedMenuItem']",
                "target": "$['parameters']['radius']"

            },

            {

                "source": "$['mobilecheckboxgroup_303:selectedOption']",
                "target_transformation": function(value) {
                    return (value.join(" OR "));

                },
                "target": "$['parameters']['keyword']"

            }

            ]
        },

        {
            "from_name": "minprice",
            "from_type": "LOCAL_STORAGE",

            "to_name": "radar_search",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {},
                "parameters": {
                    "key": "AIzaSyB_QWi7zPKtb69Nl11UJoFUsaxqZZztYWk",
                    "types": "restaurant|food|meal_delivery|meal_takeaway|bar|cafe",
                    "opennow": "true"
                },
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['minprice']"

            }

            ]
        },

        {
            "from_name": "maxprice",
            "from_type": "LOCAL_STORAGE",

            "to_name": "radar_search",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {},
                "parameters": {
                    "key": "AIzaSyB_QWi7zPKtb69Nl11UJoFUsaxqZZztYWk",
                    "types": "restaurant|food|meal_delivery|meal_takeaway|bar|cafe",
                    "opennow": "true"
                },
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target": "$['parameters']['maxprice']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_radar_search_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "radar_search",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "results",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['results']",
                "target": "$"

            }

            ]
        },

        {
            "from_name": "radar_search",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "status",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body']['status']",
                "target_transformation": function(value) {
                    if (value == "ZERO_RESULTS") {
                        radar_search.execute({
                            data: {
                                'location': {}
                            },
                            headers: {}
                        });
                    }
                },
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_place_my_marker_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": []
    };

    Apperyio.mappings["startScreen_place_my_marker_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": []
    };

    Apperyio.mappings["startScreen_order_food_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": []
    };

    Apperyio.mappings["startScreen_order_food_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": []
    };

    Apperyio.mappings["startScreen_reserve_table_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "phone_number",
            "from_type": "LOCAL_STORAGE",

            "to_name": "reserve_table",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "X-Appery-Database-Id": "{database_id}"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "source": "$",
                "target_transformation": function(value) {
                    var query_string = "{'Phone':'";

                    query_string = query_string + value.substring(1, 4) + value.substring(6, 9) + value.substring(10, 14) + "'}";

                    console.log(query_string);
                    return query_string;
                },
                "target": "$['parameters']['where']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_reserve_table_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {
            "from_name": "reserve_table",
            "from_type": "SERVICE_RESPONSE",

            "to_name": "opentable_link",
            "to_type": "LOCAL_STORAGE",

            "mappings": [

            {

                "source": "$['body'][0]['Mobile_link']",
                "target": "$"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_yelp_search_onbeforesend_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": [

        {

            "to_name": "yelp_search",
            "to_type": "SERVICE_REQUEST",

            "to_default": {
                "headers": {
                    "oauth_consumer_key": "wsFxPEiroBVB8HguPSUqgA",
                    "oauth_token": "_2QI1EglhlwOLnU_3CPTKIJWdskvdyUe",
                    "oauth_signature_method": "hmac-sha1"
                },
                "parameters": {},
                "body": null
            },

            "mappings": [

            {

                "target_transformation": function(value) {
                    return Math.random().toString(30).slice(2);
                },
                "target": "$['headers']['oauth_nonce']"

            },

            {

                "target_transformation": function(value) {
                    // notes:
                    // not sure if string should include ? (%3F) after "search"
                    // nonce doesn't sync with real nonce passed in header
                    // timestamp also random chars
                    var message = "GET" + "%26http%3A%2F%2F" + "api.yelp.com%2Fv2%2Fsearch%3F" + "oauth_consumer_key%3D" + "wsFxPEiroBVB8HguPSUqgA" + "%26oauth_nonce%3D" + "b7869743b1599850a2db6e92fc2a6239" + "%26oauth_signature_method%3D" + "hmac-sha1" + "%26oauth_timestamp%3D" + "3D1414090806" + "%26oauth_token%3D" + "_2QI1EglhlwOLnU_3CPTKIJWdskvdyUe" + "%26oauth_version%3D" + "1.0";

                    var passphrase = "m1PU5fCMeTnOmBk_3LwPpR1lxXQ&hnAv6T7xcG8urvNDO2HcI_IgBzw";

                    return CryptoJS.HmacSHA1(message, passphrase);

                },
                "target": "$['headers']['oauth_signature']"

            },

            {

                "target_transformation": function(value) {
                    var milliseconds = (new Date).getTime();

                    return milliseconds;
                },
                "target": "$['headers']['oauth_timestamp']"

            }

            ]
        }

        ]
    };

    Apperyio.mappings["startScreen_yelp_search_onsuccess_mapping_0"] = {
        "homeScreen": "startScreen",
        "directions": []
    };

    Apperyio.datasources = Apperyio.datasources || {};

    window.geolocation1 = Apperyio.datasources.geolocation1 = new Apperyio.DataSource(GeolocationService, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_geolocation1_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            try {
                place_my_marker.execute({});
            } catch (e) {
                console.error(e);
                hideSpinner();
            };

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_geolocation1_onsuccess_mapping_0"]);
            var mapDiv = Appery('map');

            // set user location
            var lat = localStorage.getItem('markerLat');
            var lng = localStorage.getItem('markerLng');
            var lat_lng = lat + ',' + lng;
            localStorage.setItem('markerLatLng', lat_lng);

            // place marker
            var myLoc = new google.maps.LatLng(lat, lng);
            if (marker) deleteMarker(marker);
            directionsDisplay.setMap(null);
            marker = new google.maps.Marker({
                position: myLoc,
                map: map
            });

            mapDiv.refresh();
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.get_details = Apperyio.datasources.get_details = new Apperyio.DataSource(getDetails, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_get_details_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_get_details_oncomplete_mapping_0"]);
            $('.spinner').removeAttr('disabled');

            var website = localStorage.getItem('website');

            if (website != "No website. Try calling!" && website != "Change filters and spin again") {
                $(".restaurant_link_id").contents().unwrap(); // remove previous link to avoid proliferation of nested anchor tags
                $(".restaurant_link").attr("src", "files/views/assets/image/globe-red.png");
                $(".restaurant_link").wrap($("<a class='restaurant_link_id'>").attr("href", website));
                $(".restaurant_link_id").attr("target", "_blank"); // open in new tab or native browser
            } else {
                // disable the link
                $(".restaurant_link_id").removeAttr('href');
                $(".restaurant_link_id").removeAttr('target');
                $(".restaurant_link").attr("src", "files/views/assets/image/globe.png");
            }

            var phone_number = localStorage.getItem('phone_number');

            if (phone_number != " " && website != "Change filters and spin again") {
                $(".phone_number_link_id").contents().unwrap(); // remove previous number to avoid proliferation of nested anchor tags
                $(".phone_number_link").wrap($("<a class='phone_number_link_id'>").attr("href", "tel:1-" + phone_number));
                $(".phone_number_link").attr("src", "files/views/assets/image/phone-red.png");
            } else {
                // disable the link
                $(".phone_number_link_id").removeAttr('href');
                $(".phone_number_link").attr("src", "files/views/assets/image/phone.png");
            }

            reserve_table.execute();

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_get_details_onsuccess_mapping_0"]);
            // store location
            var lat = localStorage.getItem('restaurantLat');
            var lng = localStorage.getItem('restaurantLng');
            var lat_lng = lat + ',' + lng;
            localStorage.setItem('restaurantLoc', lat_lng);

            // get directions
            if (localStorage.getItem('website') != 'Change filters and spin again') {
                var sourceAddress = localStorage.getItem('markerLatLng');
                var destinationAddress = localStorage.getItem('restaurantLoc');
                displayDirections(sourceAddress, destinationAddress, map);
            }

            // error checking response variables
            if (localStorage.getItem('website') === null) {
                localStorage.setItem('website', 'No website. Try calling!');
            }

            if (localStorage.getItem('phone_number') === null) {
                localStorage.setItem('phone_number', ' ');
            }

            if (localStorage.getItem('open') === null) {
                localStorage.setItem('open', ' ');
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.radar_search = Apperyio.datasources.radar_search = new Apperyio.DataSource(radarSearch, {
        "onBeforeSend": function(jqXHR) { // set user location based on map center
            var lat = localStorage.getItem('markerLat');
            var lng = localStorage.getItem('markerLng');
            var lat_lng = lat + ',' + lng;
            localStorage.setItem('markerLatLng', lat_lng);

            // set price range
            price_array = [localStorage.getItem('one_dollar') * 1, localStorage.getItem('two_dollars') * 2, localStorage.getItem('three_dollars') * 3, localStorage.getItem('four_dollars') * 4];
            var min = 4;
            var max = 1;
            localStorage.setItem('minprice', min);
            localStorage.setItem('maxprice', max);

            for (i = 0; i < price_array.length; i++) {
                price = price_array[i];
                if ((price < min) && (price > 0)) {
                    localStorage.setItem('minprice', price);
                    min = price;
                }

                if ((price > max) && (price > 0)) {
                    localStorage.setItem('maxprice', price);
                    max = price;
                }
            }

            if (min == 4 && max == 1) {
                localStorage.setItem('minprice', 1);
                localStorage.setItem('maxprice', 4);
            };
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_radar_search_onbeforesend_mapping_1"]);
            var cuisine = localStorage.getItem('cuisine2');

/*var cuisines = document.getElementsByName('cuisine2');
var selected = [];
for (var i=0; i<cuisines.length; i++) {
    if (cuisines[i].checked) {
        selected.push(cuisines[i].value);
    }
}*/

            if (cuisine == "Bar") localStorage.setItem("types", "bar");
            else localStorage.setItem("types", "restaurant|food|meal_delivery|meal_takeaway|bar|cafe");
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_radar_search_onsuccess_mapping_0"]);
            // retrieve API output
            var results = Apperyio.storage.results.get();
            // find length of API output
            var length = results.length;

            if (length > 0) {
                // generate random integer from 0 to length-1
                var rand = Math.floor(Math.random() * (length - 1));
                // pull place id from list
                var place_id = Apperyio.storage.results.get("$[" + rand + "]['place_id']");
                // save chosen place to local var
                localStorage.setItem('place_id', place_id);
            } else localStorage.setItem('place_id', 'none');

            ;
            try {
                get_details.execute({});
            } catch (e) {
                console.error(e);
                hideSpinner();
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.place_my_marker = Apperyio.datasources.place_my_marker = new Apperyio.DataSource(PlaceMyMarker, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_place_my_marker_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_place_my_marker_onsuccess_mapping_0"]);
            var markerLatLng = new google.maps.LatLng(localStorage.getItem('markerLat'), localStorage.getItem('markerLng'));

            var marker = new google.maps.Marker({
                position: markerLatLng,
                map: map,
                title: "My location",
                animation: google.maps.Animation.DROP
            });

            bounds.extend(markerLatLng);
            map.fitBounds(bounds);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.order_food = Apperyio.datasources.order_food = new Apperyio.DataSource(orderFood, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_order_food_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_order_food_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.reserve_table = Apperyio.datasources.reserve_table = new Apperyio.DataSource(features_reservations_query_service, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_reserve_table_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_reserve_table_onsuccess_mapping_0"]);
            var reserve = localStorage.getItem("opentable_link");

            if (reserve) {
                $(".reserve_table_id").contents().unwrap(); // remove previous link to avoid proliferation of nested anchor tags
                $(".reserve_table").attr("src", "files/views/assets/image/reserveatable.jpg");
                $(".reserve_table").wrap($("<a class='reserve_table_id'>").attr("href", reserve));
                $(".reserve_table_id").attr("target", "_blank"); // open in new tab or native browser
            } else {
                // disable the link
                $(".reserve_table_id").removeAttr('href');
                $(".reserve_table_id").removeAttr('target');
                $(".reserve_table").removeAttr("src");
            };
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    window.yelp_search = Apperyio.datasources.yelp_search = new Apperyio.DataSource(yelpSearch, {
        "onBeforeSend": function(jqXHR) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_yelp_search_onbeforesend_mapping_0"]);
        },
        "onComplete": function(jqXHR, textStatus) {

            Apperyio.refreshScreenFormElements("startScreen");
        },
        "onSuccess": function(data) {
            Apperyio.processMappingAction(Apperyio.mappings["startScreen_yelp_search_onsuccess_mapping_0"]);
        },
        "onError": function(jqXHR, textStatus, errorThrown) {}
    });

    Apperyio.CurrentScreen = 'startScreen';
    _.chain(Apperyio.mappings).filter(function(m) {
        return m.homeScreen === Apperyio.CurrentScreen;
    }).each(Apperyio.UIHandler.hideTemplateComponents);

    /*
     * Events and handlers
     */

    // On Load
    var startScreen_onLoad = function() {
            startScreen_elementsExtraJS();

            initialize();
            try {
                geolocation1.execute({});
            } catch (e) {
                console.error(e);
                hideSpinner();
            };

            startScreen_deviceEvents();
            startScreen_windowEvents();
            startScreen_elementsEvents();
        };

    // screen window events


    function startScreen_windowEvents() {

        $('#startScreen').bind('pageshow orientationchange', function() {
            var _page = this;
            adjustContentHeightWithPadding(_page);
        });

    };

    // device events


    function startScreen_deviceEvents() {
        document.addEventListener("deviceready", function() {

        });
    };

    // screen elements extra js


    function startScreen_elementsExtraJS() {
        // screen (startScreen) extra code

        /* google_map */

        $("[name = 'google_map']").wrap("<div/>");
        $("[name = 'google_map']").parent().css("margin-left", $("[name = 'google_map']").css("margin-left"));
        $("[name = 'google_map']").parent().css("margin-right", $("[name = 'google_map']").css("margin-right"));
        $("[name = 'google_map']").css("margin-left", '0');
        $("[name = 'google_map']").css("margin-right", '0');

        var google_map_options = {
            markerSourceName: "google_map_markers",
            latitude: "",
            longitude: "",
            address: "",
            zoom: 14,
            showLocationMarker: false
        }

        Apperyio.__registerComponent('google_map', new Apperyio.ApperyMapComponent("google_map", google_map_options));
        $("[name='google_map_markers'] [apperytype='marker']").attr("reRender", "google_map");
        $(":mobile-pagecontainer").off("pagecontainershow.startScreen_mobilecontainer").on("pagecontainershow.startScreen_mobilecontainer", function(event, ui) {
            if (($('#startScreen_google_map', ui.toPage).length > 0) && (Apperyio('google_map') != undefined)) {
                Apperyio('google_map').refresh();
            }
        });

        /* distance_menu */

        $("#startScreen_distance_menu").parent().find("a.ui-btn").attr("tabindex", "66");

        /* rating_menu */

        $("#startScreen_rating_menu").parent().find("a.ui-btn").attr("tabindex", "71");

        /* mobilecollapsblock_300 */

        $("#startScreen_mobilecollapsblock_300 .ui-collapsible-heading-toggle").attr("tabindex", "67");

    };

    // screen elements handler


    function startScreen_elementsEvents() {
        $(document).on("click", "a :input,a a,a fieldset label", function(event) {
            event.stopPropagation();
        });

        $(document).off("select click", '#startScreen_mobilecontainer [name="header_button"]').on({
            select: function(event) {
                this.disabled = true;
            },
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    this.disabled = true;

                }
            },
        }, '#startScreen_mobilecontainer [name="header_button"]');
        $(document).off("click", '#startScreen_mobilecontainer [name="filters"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    $('[id="startScreen_filters_panel"]').panel("open");

                }
            },
        }, '#startScreen_mobilecontainer [name="filters"]');
        $(document).off("click", '#startScreen_mobilecontainer [name="details"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    $('[id="startScreen_details_panel"]').panel("open");

                }
            },
        }, '#startScreen_mobilecontainer [name="details"]');

        $(document).off("click", '#startScreen_mobilecontainer [name="recenter"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // resets to current loca
                    resetLoc();

                }
            },
        }, '#startScreen_mobilecontainer [name="recenter"]');
        $(document).off("click", '#startScreen_mobilecontainer [name="drop_pin"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // sets new location
                    dropPin();

                }
            },
        }, '#startScreen_mobilecontainer [name="drop_pin"]');
        $(document).off("change", '#startScreen_mobilecontainer [name="Output"]').on({
            change: function(event) {
                Apperyio.processMappingAction(Apperyio.mappings["startScreen_Output_onchange_mapping_0"]);
            },
        }, '#startScreen_mobilecontainer [name="Output"]');

        $(document).off("click", '#startScreen_mobilecontainer [name="spin_button"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    $(this).rotate();
                    $('.spinner').attr('disabled', 'true');

                    var rating = localStorage.getItem('rating');

/*
if(rating == 0)
    radar_search.execute();
else
    yelp_search.execute();
*/
                    ;
                    try {
                        radar_search.execute({});
                    } catch (e) {
                        console.error(e);
                        hideSpinner();
                    };

                }
            },
        }, '#startScreen_mobilecontainer [name="spin_button"]');

        $(document).off("click", '#startScreen_filters_panel [name="one_dollar"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // toggle state
                    changePriceState('one_dollar');
                    // change color
                    changeColor('one_dollar');;

                }
            },
        }, '#startScreen_filters_panel [name="one_dollar"]');

        $(document).off("click", '#startScreen_filters_panel [name="two_dollars"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // toggle state
                    changePriceState('two_dollars');
                    // change color
                    changeColor('two_dollars');

                }
            },
        }, '#startScreen_filters_panel [name="two_dollars"]');

        $(document).off("click", '#startScreen_filters_panel [name="three_dollars"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // toggle state
                    changePriceState('three_dollars');
                    // change color
                    changeColor('three_dollars');

                }
            },
        }, '#startScreen_filters_panel [name="three_dollars"]');

        $(document).off("click", '#startScreen_filters_panel [name="four_dollars"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) { // toggle state
                    changePriceState('four_dollars');
                    // change color
                    changeColor('four_dollars');

                }
            },
        }, '#startScreen_filters_panel [name="four_dollars"]');

        $(document).off("change", '#startScreen_filters_panel [name="rating_menu"]').on({
            change: function(event) {
                try {
                    $a.storage["rating"].update("$", $a.c15r($a.UIHandler.resolveGeneratedComponent('rating_menu', this), 'get', 'selectedMenuItem'))
                } catch (e) {
                    console.error(e)
                };
            },
        }, '#startScreen_filters_panel [name="rating_menu"]');

        $(document).off("click", '#startScreen_filters_panel [name="close_filters"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    $('[id="startScreen_filters_panel"]').panel("close");

                }
            },
        }, '#startScreen_filters_panel [name="close_filters"]');

        $(document).off("click", '#startScreen_details_panel [name="close_details"]').on({
            click: function(event) {
                if (!$(this).attr('disabled')) {
                    $('[id="startScreen_details_panel"]').panel("close");

                }
            },
        }, '#startScreen_details_panel [name="close_details"]');

    };

    $(document).off("pagebeforeshow", "#startScreen").on("pagebeforeshow", "#startScreen", function(event, ui) {
        Apperyio.CurrentScreen = "startScreen";
        _.chain(Apperyio.mappings).filter(function(m) {
            return m.homeScreen === Apperyio.CurrentScreen;
        }).each(Apperyio.UIHandler.hideTemplateComponents);
    });

    startScreen_onLoad();
};

$(document).off("pagecreate", "#startScreen").on("pagecreate", "#startScreen", function(event, ui) {
    Apperyio.processSelectMenu($(this));
    startScreen_js();
});